<!doctype html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Walk-In Tally</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding:20px; background:#f6f7f9; margin:0; }
  .card { max-width:560px; margin:auto; background:white; padding:20px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.1); }
  h2 { margin:0 0 10px; }
  label { font-weight:800; font-size:13px; display:block; margin-top:12px; }
  input, select {
    width:100%; padding:10px; margin-top:6px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box;
    font-size:15px;
  }
  .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center; }
  button {
    padding:12px 14px; background:#2563eb; color:white; border:0; border-radius:12px; font-weight:800; cursor:pointer;
  }
  button.secondary { background:#e5e7eb; color:#111827; }
  button:disabled { opacity:.65; cursor:not-allowed; }
  .status { margin-top:12px; font-weight:800; }
  .ok { color:#166534; }
  .bad { color:#b91c1c; }
  .muted { color:#6b7280; font-size:13px; margin-top:6px; line-height:1.35; }
  code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
  .box { margin-top:12px; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fbfbfc; }
  .checkRow { display:flex; gap:10px; align-items:flex-start; margin-top:12px; }
  .checkRow input { margin-top:4px; width:18px; height:18px; }
</style>
</head>
<body>

<div class="card">
  <h2>Walk-In Tally</h2>
  <div class="muted">
    Use this for walk-ins counted by stake. Shift is determined automatically based on time of submission.
  </div>

  <div id="geoBox" class="box" style="display:none;">
    <div class="muted">
      <strong>Location:</strong>
      <span id="geoText"></span>
    </div>
  </div>

  <form id="walkForm" novalidate>
    <label for="stake">Stake</label>
    <select id="stake" name="stake" required>
      <option value="">Select stake</option>
    </select>

    <label for="count">Number of People</label>
    <input id="count" type="number" name="count" min="1" required>

    <label for="submittedBy">Your Full Name (Walk-in Volunteer)</label>
    <input id="submittedBy" type="text" name="submittedBy" autocomplete="name" required>

    <div class="checkRow">
      <input type="checkbox" id="safetyBriefing" name="safetyBriefing">
      <div class="muted">
        I received the orchard safety briefing today and agree to follow orchard safety rules.
      </div>
    </div>

    <div class="row">
      <button id="submitBtn" type="submit">Submit</button>
      <button id="retryGeoBtn" class="secondary" type="button">Retry Location</button>
    </div>

    <div id="status" class="status"></div>
    <div class="muted" id="hint"></div>
  </form>
</div>

<script>
const WEBHOOK = "https://hook.us2.make.com/dn8du4dk8n4jdxothrkl2ai6dl5kcyic";

const GEOFENCE_CENTER_LAT = 41.301141;
const GEOFENCE_CENTER_LNG = -112.07506;
const GEOFENCE_RADIUS_METERS = 300;

const GEO_OPTS = {
  enableHighAccuracy: true,
  timeout: 30000,
  maximumAge: 60000
};

const STAKES = [
  "BenLomond","Hooper","PerryUtah","OgdenMoundFort","WestHaven",
  "PleasantView","PlainCity","NorthOgdenEast","Kanesville",
  "OgdenWest","HooperUtahPioneerTrail","WestHavenNorth","Willard"
];

const statusEl = document.getElementById("status");
const hintEl = document.getElementById("hint");
const geoBox = document.getElementById("geoBox");
const geoText = document.getElementById("geoText");
const submitBtn = document.getElementById("submitBtn");
const retryGeoBtn = document.getElementById("retryGeoBtn");
const stakeSel = document.getElementById("stake");
const form = document.getElementById("walkForm");

let geoOk = false;
let geoInfo = null;
let isSubmitting = false;

function setStatus(msg, ok=true) {
  statusEl.textContent = msg || "";
  statusEl.className = ok ? "status ok" : "status bad";
}

function distanceMeters(lat1, lon1, lat2, lon2) {
  const toRad = (x) => (x * Math.PI) / 180;
  const R = 6371000;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function getPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error("Geolocation not supported."));
    navigator.geolocation.getCurrentPosition(resolve, reject, GEO_OPTS);
  });
}

function formatMMDDYYYY(d) {
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const yyyy = d.getFullYear();
  return `${mm}/${dd}/${yyyy}`;
}

function shiftFromTime(d) {
  return d.getHours() < 12 ? "AM Volunteer" : "PM Volunteer";
}

STAKES.forEach(s => {
  const opt = document.createElement("option");
  opt.value = s;
  opt.textContent = s;
  stakeSel.appendChild(opt);
});

async function runGeofence() {
  geoOk = false;
  geoBox.style.display = "none";
  setStatus("Checking location…");

  const pos = await getPosition();
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  const accuracy = pos.coords.accuracy;
  const dist = distanceMeters(lat, lng, GEOFENCE_CENTER_LAT, GEOFENCE_CENTER_LNG);

  geoInfo = { lat, lng, accuracyMeters: accuracy, distanceMeters: dist };

  geoBox.style.display = "block";
  geoText.innerHTML =
    `<code>${Math.round(dist)}m</code> from orchard (allowed <code>${GEOFENCE_RADIUS_METERS}m</code>, accuracy ±<code>${Math.round(accuracy)}m</code>)`;

  if (dist > GEOFENCE_RADIUS_METERS) {
    setStatus("Not at orchard location — submission blocked.", false);
    return;
  }

  geoOk = true;
  setStatus("Location verified ✓", true);
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!geoOk) {
    setStatus("Location not verified.", false);
    return;
  }

  if (isSubmitting) return;
  isSubmitting = true;
  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting…";

  const now = new Date();
  const payload = {
    source: "walkin",
    submittedAt: now.toISOString(),
    date: formatMMDDYYYY(now),
    shift: shiftFromTime(now),
    stake: stakeSel.value,
    count: Number(document.getElementById("count").value),
    submittedBy: document.getElementById("submittedBy").value.trim(),
    safetyBriefingAttested: document.getElementById("safetyBriefing").checked,
    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    geo: geoInfo
  };

  try {
    const r = await fetch(WEBHOOK, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    if (!r.ok) throw new Error("Submission failed");

    setStatus("Walk-in recorded ✓", true);
    hintEl.textContent = `Recorded as ${payload.shift} for ${payload.date}.`;
    form.reset();
  } catch (err) {
    setStatus("Submit failed. Please tell the orchard lead.", false);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit";
    isSubmitting = false;
  }
});

retryGeoBtn.addEventListener("click", () => {
  runGeofence().catch(err => {
    setStatus(`Location check failed: ${err.message}`, false);
  });
});

runGeofence().catch(err => {
  setStatus(`Location check failed: ${err.message}`, false);
});
</script>

</body>
</html>
